CREATE TABLE cliente (
	codigo 	varchar2(10) PRIMARY KEY,
	nome varchar2(15) NOT NULL,
	sobrenome char(20) NOT NULL,
	sexo char(1) NOT NULL,
	pontos number NOT NULL,
	email char(40) NOT NULL,
	data_de_nasc date NOT NULL,
	CONSTRAINT cliente_sexo check(sexo='m' or sexo='f'),
	CONSTRAINT cliente_pontos check(pontos>=0)
);

CREATE TABLE telefones (
	cod_cliente NOT NULL,
	telefone numeric(11.0) NOT NULL,
	PRIMARY KEY (cod_cliente, telefone),
	CONSTRAINT cod_cliente_tel FOREIGN KEY (cod_cliente) REFERENCES cliente(codigo)
);

CREATE TABLE endereco_cliente (
	codigo varchar2(10) PRIMARY KEY,
	rua char(40) NOT NULL,
	numero number NOT NULL,
	bairro char(25) NOT NULL,
	cep numeric(8.0) NOT NULL,
	cidade char(40) NOT NULL,
	estado char(25) NOT NULL,
	CONSTRAINT endereco_codigo FOREIGN KEY (codigo) REFERENCES cliente(codigo)
);

CREATE TABLE email (
	codigo varchar2(10) PRIMARY KEY,
	assunto varchar2(20) NOT NULL,
	data_envio date NOT NULL,
	conteudo clob NOT NULL
);

CREATE TABLE carrinho (
	codigo varchar2(10) PRIMARY KEY,
	constraint carrinho_codigo FOREIGN KEY (codigo) REFERENCES cliente(codigo)
	CONSTRAINT fk_cupom FOREIGN KEY (codigo_cupom) REFERENCES cupom_de_desc(codigo)
);

CREATE TABLE cupom_de_desc (
	codigo varchar2(10) PRIMARY KEY,
	desconto number NOT NULL
	CONSTRAINT fk_categoria FOREIGN KEY (categoria_cupom) REFERENCES categoria(codigo)
);

CREATE TABLE historico (
	codigo varchar2(10) PRIMARY KEY,
	data date NOT NULL,
	finalizou char(1),
	tempo_de_permanencia timestamp,
	CONSTRAINT cod_cliente_hist FOREIGN KEY (codigo) REFERENCES cliente(codigo),
	CONSTRAINT historico_finalizou check(finalizou=null or finalizou='y' or finalizou='n')
);

CREATE TABLE indica (
	data date NOT NULL,
	cod_indicou varchar2(10) NOT NULL,
	cod_indicado varchar2(10) PRIMARY KEY,
	CONSTRAINT cliente_indicou FOREIGN KEY (cod_indicou) REFERENCES cliente(codigo),
	CONSTRAINT cliente_indicado FOREIGN KEY (cod_indicado) REFERENCES cliente(codigo)
);

CREATE TABLE recebe (
	clicou_no_conteudo char(1) NOT NULL,
	abriu char(1) NOT NULL,
	cod_cliente char(10) NOT NULL,
	cod_email varchar2(10) NOT NULL,
	PRIMARY KEY (cod_cliente, cod_email),
	CONSTRAINT recebe_cliente FOREIGN KEY (cod_cliente) REFERENCES cliente(codigo),
	CONSTRAINT recebe_email FOREIGN KEY (cod_email) REFERENCES email(codigo),
	CONSTRAINT recebe_abriu_clicou check((abriu='y' or abriu='n') and (clicou_no_conteudo='y' or clicou_no_conteudo='n'))
);

CREATE TABLE nota_fiscal (
	id_nf integer NOT NULL,
	numero integer NOT NULL,
	serie integer NOT NULL,
	inscricao_estadual integer NOT NULL,
	chave_de_acesso varchar2(20) NOT NULL,
	valor_total integer NOT NULL,
	PRIMARY KEY (id_nf)
);

CREATE TABLE esta_associado (
	id_nf integer NOT NULL,
	id_ordem_compra integer NOT NULL,
	PRIMARY KEY (id_nf, id_ordem_compra),
	CONSTRAINT FK_NF FOREIGN KEY (id_nf) REFERENCES nota_fiscal(id_nf)
);

CREATE TABLE ordem_de_compra(
	id_ordem_compra integer NOT NULL,
	id_endereco integer NOT NULL,
	data_compra varchar2(10) NOT NULL,
	status_compra varchar2(20) NOT NULL,
	desconto integer NOT NULL,
	preco_frete integer NOT NULL,
	PRIMARY KEY (id_ordem_compra)
);

CREATE TABLE endereco (
	id_endereco integer NOT NULL,
	id_ordem_compra integer NOT NULL,
	id_transportadora integer NOT NULL,
	cidade VARCHAR2(20) NOT NULL,
	bairro VARCHAR2(20) NOT NULL,
	numero integer NOT NULL,
	cep integer NOT NULL,
	rua varchar2(20) NOT NULL,
	PRIMARY KEY (ID_ENDERECO),
	CONSTRAINT fk_ordem_compra FOREIGN KEY (id_ordem_compra) REFERENCES ordem_de_compra(id_ordem_compra)
);

CREATE TABLE transportadora (
	id_transportadora integer PRIMARY KEY,
	id_endereco integer NOT NULL,
	nome varchar2(20) NOT NULL,
	email varchar2(20) NOT NULL,
	telefone varchar2(20) NOT NULL,
	site varchar2(20) NOT NULL,
	CONSTRAINT fk_endereco FOREIGN KEY (id_endereco) REFERENCES endereco(id_endereco)
);

CREATE TABLE transporta (
	id_transportadora integer NOT NULL,
	id_ordem_compra integer NOT NULL,
	PRIMARY KEY (id_transportadora, id_ordem_compra),
	CONSTRAINT fk_transportadora_transporta FOREIGN KEY (id_transportadora) REFERENCES transportadora(id_transportadora),
	CONSTRAINT fk_ordem_compra_transporta FOREIGN KEY (id_ordem_compra) REFERENCES ordem_de_compra(id_ordem_compra)
);


ALTER TABLE esta_associado ADD CONSTRAINT fk_ordem_compra_associado FOREIGN KEY (id_ordem_compra) REFERENCES ordem_de_compra(id_ordem_compra);
ALTER TABLE ordem_de_compra ADD CONSTRAINT fk_endereco_ordem FOREIGN KEY (id_endereco) REFERENCES endereco(id_endereco);
ALTER TABLE endereco ADD CONSTRAINT fk_transportadora FOREIGN KEY (id_transportadora) REFERENCES transportadora(id_transportadora);


CREATE TABLE fornecedor (
	codigo varchar2(11) PRIMARY KEY,
	home_page varchar2(40) NOT NULL,
	nome varchar2(15) NOT NULL,
	email varchar2(40) NOT NULL,
	telefone numeric(11.0) NOT NULL
);

CREATE TABLE endereco_fornecedor (
	codigo_fornecedor varchar2(11) PRIMARY KEY,
	cep varchar2(9) NOT NULL,
	estado char(2) NOT NULL,
	cidade varchar2(15) NOT NULL,
	bairro varchar2(10) NOT NULL,
	numero varchar2(11) NOT NULL,
	rua varchar(15) NOT NULL,
	CONSTRAINT fk_endereco_fornecedor FOREIGN KEY (codigo_fornecedor) REFERENCES fornecedor(codigo)
);

CREATE TABLE centro_de_distribuicao (
	nome varchar2(15) NOT NULL,
	codigo char(11) PRIMARY KEY
);


CREATE TABLE endereco_centro_de_distribuicao (
	codigo_centro char(11) PRIMARY KEY,
	cep varchar2(8) NOT NULL,
	estado char(2) NOT NULL,
	cidade varchar2(15) NOT NULL,
	bairro varchar2(10) NOT NULL,
	numero varchar2(11) NOT NULL,
	rua varchar2(15) NOT NULL,
	CONSTRAINT fk_codigo_centro FOREIGN KEY (codigo_centro) REFERENCES centro_de_distribuicao(codigo)
);



CREATE TABLE categoria (
	nome varchar2(15) NOT NULL,
	codigo char(11) PRIMARY KEY
);

CREATE TABLE produto (
	cod_categoria char(11) NOT NULL,
	cod_fornecedor varchar2(11) NOT NULL,
	codigo char(11) PRIMARY KEY,
	nome varchar2(15) NOT NULL,
	preço real NOT NULL,
	data_de_fabricação date NOT NULL,
	descrição varchar2(30) NOT NULL,
	especificação varchar2(15) NOT NULL,
	data_de_validade date NOT NULL,
	CONSTRAINT fk_produto_categoria FOREIGN KEY (cod_categoria) REFERENCES categoria(codigo),
	CONSTRAINT fk_produto_fornecedor FOREIGN KEY (cod_fornecedor) REFERENCES fornecedor(codigo)
);

CREATE TABLE foto_produto (
	foto blob NOT NULL,
	cod_produto char(11) PRIMARY KEY,
	CONSTRAINT fk_foto_produto FOREIGN KEY (cod_produto) REFERENCES produto(codigo)
);

CREATE TABLE estocado (
	cod_produto char(11) PRIMARY KEY,
	quantidade integer NOT NULL,
	CONSTRAINT fk_estocado_produto FOREIGN KEY (cod_produto) REFERENCES produto(codigo)
);

CREATE TABLE avalia (
	cod_produto char(11) NOT NULL,
	id_ordem_compra integer NOT NULL,
	nota integer NOT NULL,
	descricao varchar2(30) NOT NULL,
	PRIMARY KEY (cod_produto, id_ordem_compra),
	CONSTRAINT fk_avalia_produto FOREIGN KEY (cod_produto) REFERENCES produto(codigo),
	CONSTRAINT fk_avalia_ordem FOREIGN KEY (id_ordem_compra) REFERENCES ordem_de_compra(id_ordem_compra)
);

CREATE TABLE possui (
	cod_produto char(11) NOT NULL,
	id_ordem_compra integer NOT NULL,
	quantidade integer NOT NULL,
	valor real NOT NULL,
	PRIMARY KEY (cod_produto, id_ordem_compra),
	CONSTRAINT fk_possui_produto FOREIGN KEY (cod_produto) REFERENCES produto(codigo),
	CONSTRAINT fk_possui_ordem FOREIGN KEY (id_ordem_compra) REFERENCES ordem_de_compra(id_ordem_compra)
);

CREATE TABLE tem (
	cod_produto char(11) NOT NULL,
	cod_carrinho varchar2(10) NOT NULL,
	quantidade integer NOT NULL,
	PRIMARY KEY (cod_produto, cod_carrinho),
	CONSTRAINT fk_tem_produto FOREIGN KEY (cod_produto) REFERENCES produto(codigo),
	CONSTRAINT fk_tem_carrinho FOREIGN KEY (cod_carrinho) REFERENCES carrinho(codigo)
);